# Used by Coolify
# Removed "python" provider to prevent nixpacks from auto-detecting UV and trying to install it
# We'll manually install Python packages in the install phase

providers = ["deno"]

[phases.setup]
nixPkgs = [
  "...",
  # Install Python since we removed the python provider
  "python3",
  # Install sops and age so that we can decrypt the secrets from .env.yaml
  "sops",
  "age",
  # Needed for the deno installer
  "unzip",
]
cmds = [
  # Download the same version of Deno we have in mise.toml (and which was used to generate the lockfile)
  "curl -fsSL https://deno.land/install.sh | sh -s v2.4.1",
]

[phases.install]
# Manually install UV and Python packages (no python provider = no auto-detection)
cmds = [
  # Install UV using official installer
  "curl -LsSf https://astral.sh/uv/install.sh | sh",
  # Create venv and install dependencies with UV
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && ~/.local/bin/uv sync --no-dev --frozen",
]

[start]
# Run the app with the decrypted secrets
# Activate venv and add tools to PATH
cmd = """PATH=/root/.deno/bin:/root/.local/bin:/opt/venv/bin:$PATH bash -c 'deno install; sops exec-env .env.yaml "uv run emilybot"'"""
