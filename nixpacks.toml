# Used by Coolify

providers = ["deno", "python"]

[phases.setup]
nixPkgs = [
  "...",
  # Install sops and age so that we can decrypt the secrets from .env.yaml
  "sops",
  "age",
  # Needed for the deno installer
  "unzip",
]
cmds = [
  # Download the same version of Deno we have in mise.toml (and which was used to generate the lockfile)
  "curl -fsSL https://deno.land/install.sh | sh -s v2.4.1",
  # Hide uv.lock temporarily so nixpacks doesn't auto-detect UV
  "mv uv.lock uv.lock.bak",
]

[phases.install]
# Install UV manually since nixpacks' auto-install has empty $NIXPACKS_UV_VERSION
# We hid uv.lock in setup to prevent nixpacks from trying to install UV
cmds = [
  "curl -LsSf https://astral.sh/uv/install.sh | sh",
  # Restore uv.lock for the actual UV sync command
  "mv uv.lock.bak uv.lock",
]

[start]
# Run the app with the decrypted secrets
cmd = """PATH=/root/.deno/bin:$PATH bash -c 'deno install; sops exec-env .env.yaml "uv run emilybot"'"""
